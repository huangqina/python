<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="Content-Style-Type" content="text/css"><meta name="generator" content="Aspose.Words for .NET 15.1.0.0"><title></title></head><body><div><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">#coding=utf-8</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">#mongo.py</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">from flask import Flask,abort</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">from flask import jsonify</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">from flask import request</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">from flask_pymongo import PyMongo</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">from flask_script import Manager</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">import json</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">app = Flask(__name__)</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">app.config['MONGO_DBNAME'] = 'test'</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">app.config['MONGO_URI'] = 'mongodb://127.0.0.1:12345/test'&nbsp; #如果部署在本上，其中ip地址可填127.0.0.1</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">mongo = PyMongo(app)</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">manager = Manager(app)</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">#@app.route('/login', methods=['GET'])</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">#def get_all_users():</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; #star = mongo.db.userInfo.find()</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; #output = []</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; #for s in star:</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; #&nbsp; output.append({'name' : s['name'], 'pwd' : s['pwd']})</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; #return jsonify({'result' : output})</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">#@app.route('/findpanel/&lt;int:num&gt;') </span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">@app.route('/')</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">def re():</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp;
 return '&lt;p&gt;192.168.2.25:8080/finddefect&nbsp;&nbsp;&nbsp;&nbsp; 
#defect of certain panel with given 
barcode&lt;/p&gt;&lt;p&gt;192.168.2.25:8080/adduser&nbsp;&nbsp;&nbsp;&nbsp;
 #Insert&nbsp; 
user&lt;/p&gt;&lt;p&gt;192.168.2.25:8080/addpanel&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 #Insert&nbsp; 
panel&lt;/p&gt;&lt;p&gt;192.168.2.25:8080/defect&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 #Insert&nbsp; 
defect&lt;/p&gt;&lt;p&gt;192.168.2.25:8080/findbytime&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 #no. of defect panel in given time period no. of ok panel in given time
 
period&lt;/p&gt;&lt;p&gt;192.168.2.25:8080/missrate&nbsp;&nbsp;&nbsp;&nbsp;
 #miss rate (new annotation by operator / cells 
checked)&lt;/p&gt;&lt;p&gt;192.168.2.25:8080/overkillrate&nbsp;&nbsp;&nbsp;&nbsp;
 #overkill rate (deleted AI annotation by operator / cells 
checked)&lt;/p&gt;&lt;p&gt;192.168.2.25:8080/defecttime&nbsp;&nbsp;&nbsp;&nbsp;
 #no. of certain defect in given time period&lt;/p&gt;'</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">@app.route('/finddefect', methods=['GET'])</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">def find(): </span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; #user = mongo.db.users </span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; collection = mongo.db.Panel</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; Barcode = float(request.args['Barcode'])</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; I = list(mongo.db.Panel.find({"Barcode" : Barcode}).limit(1).sort([("_id" , -1)]))</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; ID = float(I[0]['ID'])</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; #username = user.find_one({"username":username}) </span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; #if username: </span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; #&nbsp;&nbsp;&nbsp; return "你查找的用户名：" + username["username"] + " 密码是：" + username["password"] </span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; #else: </span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; #&nbsp;&nbsp;&nbsp; return "你查找的用户并不存在!" </span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; k = list(collection.aggregate([</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; {'$project':{"_id":0}},</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; {'$match':{"ID":ID}},</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; {'$lookup': {'from':"Panel_Defect","pipeline":[</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {'$project':</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {"_id":0,"Defect_ID":1,"Panel_ID":1}},</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {'$match':{ "Panel_ID": ID }},</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 {'$lookup':{'from':"Defect","localField":"Defect_ID",&nbsp;&nbsp; 
"foreignField":"ID","as":"Defect"}</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }],"as": "Defects"}}]))</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp;
 a=str('ID:'+str(k[0]['ID'])+'&nbsp; '+'Barcode:' + 
str(k[0]['Barcode'])+'&nbsp; '+'type:'+str(k[0]['type'])+'&nbsp; '+ 
'size:'+ str(k[0]['size']) +'&nbsp; '+'EL_no:'+ str(k[0]['EL_no']))</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; return str(a)+'\n'+str(k[0]['Defects'])</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; # for i in k['Defects']:</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #&nbsp; print(i['Defect'])</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">@app.route('/adduser', methods=['POST'])</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">def add_user():</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; star = mongo.db.User</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; ID = request.form['ID']</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; Type = request.form['Type']</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; Name = request.form['Name']</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; PW = request.form['PW']</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; star_id = star.insert({'ID': int(ID), 'Type': Type,'Name': Name,'PW': PW})</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; new_star = star.find_one({'_id': star_id })</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; output = {'ID':</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp; new_star['ID'], 'Type': new_star['Type'],'Name':new_star['Name'], 'PW':new_star['PW']}</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; return jsonify({'result' : output})</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">@app.route('/addpanel', methods=['POST'])</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">def add_panel():</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; star = mongo.db.Panel</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; ID = request.form['ID']</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; Barcode = request.form['Barcode']</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; Type = request.form['Type']</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; Size = request.form['Size']</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; EL_no = request.form['EL_no']</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; star_id = star.insert({'ID': int(ID), 'Barcode' : int(Barcode), 'type': Type,'size': Size,'EL_no': EL_no})</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; new_star = star.find_one({'_id': star_id })</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; output = {'ID':</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;
 new_star['ID'], 'Barcode': new_star['Barcode'],'Type':new_star['type'],
 'Size':new_star['size'],'EL_no':new_star['EL_no']}</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; return jsonify({'result' : output})</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">@app.route('/adddefect', methods=['POST'])</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">def add_defect():</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; star = mongo.db.Defect</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; s = mongo.db.Panel_Defect</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; ID = float(request.form['ID'])</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; Type = request.form['Type']</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; Position = request.form['Position']</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; By = request.form['By']</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; Time = float(request.form['Time'])</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; Size = request.form['Size']</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; PanelID = request.form['PanelID']</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; star.insert({'ID': int(ID), 'type' : Type, 'Position': Position,'by': By,'time': Time,'size': Size})</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; s.insert({'ID': int(ID),'PanelID':int(PanelID)})</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; return 'ok'</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; #new_star = star.find_one({'_id': star_id })</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; #output = {'ID':</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;
 #new_star['ID'], 'Barcode': 
new_star['Barcode'],'Type':new_star['Type'], 
'Size':new_star['Size'],'EL_no':new_star['EL_no']}</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp; #return jsonify({'result' : output})</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">@app.route('/findbytime', methods=['GET']) </span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">def findbytime(): </span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; start = float(request.args['start'])</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; end = float(request.args['end'])</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; a=list(mongo.db.Panel_status.aggregate([</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; {'$match':{'time':{'$gt':start,'$lt':end}}},</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; {</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; '$group':{</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '_id' : "$result"</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ,</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'count':{'$sum':1}}}</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; ]</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; ))</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; if a:</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return str('OK'+':'+str(a[0]['count'])+' '+'Defect'+':'+str(a[1]['count']))</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; else:</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return 'None'</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">@app.route('/missrate', methods=['GET']) </span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">def missrate(): </span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp; # start = int(request.args['start'])</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp; # end = int(request.args['end'])</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; a=list(mongo.db.User_log.aggregate([</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; #{'$match':{'time':{'$gt':start,'$lt':end}}},</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; {</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; '$group':{</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '_id' : "$action"</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ,</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'count':{'$sum':1}}}</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; ]</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; ))</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; return str(a[0]['count']/(a[1]['count']+a[0]['count']))</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">@app.route('/overkillrate', methods=['GET']) </span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">def overkillrate(): </span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp; # start = int(request.args['start'])</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp; # end = int(request.args['end'])</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; #{'$match':{'time':{'$gt':start,'$lt':end}}},</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; start = float(request.args['start'])</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; end = float(request.args['end'])</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; a=list(mongo.db.Panel_status.aggregate([</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; {'$match':{'time':{'$gt':start,'$lt':end}}},</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; {</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; '$group':{</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '_id' : "$result"</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ,</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'count':{'$sum':1}}}</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; ]</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; ))</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; if a:</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return str(a)</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; else:</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return 'None'</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; return str(a[1]['count']/(a[1]['count']+a[0]['count']))</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">@app.route('/defecttime', methods=['GET']) </span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">def defecttime(): </span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp; # start = int(request.args['start'])</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp; # end = int(request.args['end'])</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; start = float(request.args['start'])</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; end = float(request.args['end'])</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; a=list(mongo.db.Defect.aggregate([</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; {'$match':{'time':{'$gt':start,'$lt':end}}},{</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; '$group':{</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '_id' : "null"</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ,</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'count':{'$sum':1}}}</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; ]</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; ))</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; b=list(mongo.db.User_log.aggregate([</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; #{'$match':{'time':{'$gt':start,'$lt':end}}},</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; {'$match':{'time':{'$gt':start,'$lt':end}}},{</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; '$group':{</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '_id' : "$action"</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ,</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'count':{'$sum':1}}}</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; ]</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; ))</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; if a and b:</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return str(a[0]['count']-b[0]['count'])</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; elif a and not b:</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return str(a[0]['count'])</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; else:</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return 'None'</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; #else a and not b:</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; #&nbsp;&nbsp;&nbsp; return str(a[0]['count'])</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">if __name__ == '__main__':</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; # app.run(host = '0.0.0.0', port = 80, debug = True)</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; app.run(host = '0.0.0.0', port = 8080, debug = True)</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;&nbsp;&nbsp; #manager.run()</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;</span></p><p style="margin:0pt"><span style="font-family:'Times New Roman'; font-size:12pt">&nbsp;</span></p></div></body></html>